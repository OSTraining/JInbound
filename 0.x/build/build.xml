<?xml version="1.0" encoding="UTF-8"?>
<!--
###################################################################
# Builder script for JInbound+
#
# @version      $Id: build.xml 1473 2010-06-15 22:25:16Z silianacom-svn $
# @copyright    Copyright (C) 2009 Yannick Gaultier. All rights reserved.
# @copyright    Copyright (C) 2011 Anything Digital. All rights reserved.
# @license      GNU/GPL
###################################################################
-->
<project name="jinbound" default="dist" basedir=".">
	<property file="config.ini" />
	<property file="config.local.ini" />
	
	<!-- <target name="dist" depends="init,copyFiles,promptUser,doChangelog,cleanprev,zipFiles,deldir,info" /> -->
	<target name="dist" depends="init,copyFiles,promptUser,doChangelog,cleanprev,zipFiles,deldir,info" />
	<target name="init">

		<!-- update marker in xml file for correct display of build number -->
		<buildnumber />

		<!-- temporary dirs used for search/replace operations -->
		<mkdir dir="${cfg.packages}/temp" />
		<mkdir dir="${cfg.packages}/temp/packages" />
		<mkdir dir="${cfg.packages}/temp/staging" />
		<mkdir dir="${cfg.packages}/temp/staging/component" />
		<mkdir dir="${cfg.packages}/temp/staging/modules" />
		<mkdir dir="${cfg.packages}/temp/staging/modules/mod_jinbound_social_bookmark" />
		<mkdir dir="${cfg.packages}/temp/staging/plugins" />
		<mkdir dir="${cfg.packages}/temp/staging/plugins/akeebasubs" />
		<mkdir dir="${cfg.packages}/temp/staging/plugins/content" />
		<mkdir dir="${cfg.packages}/temp/staging/plugins/system" />
		<mkdir dir="${cfg.packages}/temp/staging/plugins/user" />
		<mkdir dir="${cfg.packages}/temp/staging/template" />
		
		<!-- calculate version strings -->
		<condition property="str.versionforxml" value="${cfg.version}.${build.number}${cfg.versionsuffix}" else="${cfg.version}${cfg.versionsuffix}">
			<istrue value="${cfg.addbuildtoversion}" />
		</condition>
		<condition property="str.versionforxml.akeebasubs" value="${cfg.version.akeebasubs}.${build.number}${cfg.versionsuffix}" else="${cfg.version.akeebasubs}${cfg.versionsuffix}">
			<istrue value="${cfg.addbuildtoversion}" />
		</condition>
		<tstamp>
			<format property="str.datefmt" pattern="${cfg.datefmt}" locale="${cfg.dateloc}" />
		</tstamp>
		
		<!-- build up various strings -->
		<condition property="str.build" value="${cfg.buildprefix}${build.number}" else="">
			<istrue value="${cfg.addbuild}" />
		</condition>
		<condition property="str.version" value="${cfg.versionprefix}${cfg.version}" else="${cfg.version}">
			<istrue value="${cfg.addversion}" />
		</condition>
		<condition property="str.version.akeebasubs" value="${cfg.versionprefix}${cfg.version.akeebasubs}" else="${cfg.version.akeebasubs}">
			<istrue value="${cfg.addversion}" />
		</condition>
		<condition property="str.date" value="_${str.datefmt}" else="">
			<istrue value="${cfg.adddate}" />
		</condition>
		<property name="str.pkg.filename" value="${cfg.pfx.pkg}J25_J3x_${cfg.name}_${str.version}.${str.build}${cfg.versionsuffix}${str.date}" />
		<property name="str.pkg.file" value="${cfg.packages}/current/${str.pkg.filename}" />
		<property name="str.com.filename" value="${cfg.pfx.com}${cfg.name}_${str.version}.${str.build}${cfg.versionsuffix}${str.date}" />
		<property name="str.com.file" value="${cfg.packages}/temp/packages/${str.com.filename}" />
		<property name="str.tpl.filename" value="${cfg.pfx.tpl}${cfg.name}_${str.version}.${str.build}${cfg.versionsuffix}${str.date}" />
		<property name="str.tpl.file" value="${cfg.packages}/temp/packages/${str.tpl.filename}" />
		<property name="str.plg.akeebasubs.filename" value="${cfg.pfx.plg}akeebasubs_${cfg.name}_${str.version.akeebasubs}.${str.build}${cfg.versionsuffix}${str.date}" />
		<property name="str.plg.akeebasubs.file" value="${cfg.packages}/current/${str.plg.akeebasubs.filename}" />
		<property name="str.plg.content.filename" value="${cfg.pfx.plg}content_${cfg.name}_${str.version}.${str.build}${cfg.versionsuffix}${str.date}" />
		<property name="str.plg.content.file" value="${cfg.packages}/temp/packages/${str.plg.content.filename}" />
		<property name="str.plg.sys.filename" value="${cfg.pfx.plg}system_${cfg.name}_${str.version}.${str.build}${cfg.versionsuffix}${str.date}" />
		<property name="str.plg.sys.file" value="${cfg.packages}/temp/packages/${str.plg.sys.filename}" />
		<property name="str.plg.user.filename" value="${cfg.pfx.plg}user_${cfg.name}_${str.version}.${str.build}${cfg.versionsuffix}${str.date}" />
		<property name="str.plg.user.file" value="${cfg.packages}/temp/packages/${str.plg.user.filename}" />
		<property name="str.mod.bookmark.filename" value="${cfg.pfx.mod}${cfg.name}_social_bookmark_${str.version}.${str.build}${cfg.versionsuffix}${str.date}" />
		<property name="str.mod.bookmark.file" value="${cfg.packages}/temp/packages/${str.mod.bookmark.filename}" />
		
		<!-- perform filtering -->
		<filter token="ant_version_number" value="${str.versionforxml}" />
		<filter token="ant_current_date" value="${str.datefmt}" />
		<filter token="ant_copyright_header" value="${cfg.copyright}" />
		<filter token="ant_component_id" value="${cfg.pfx.com}${cfg.name}" />
		<filter token="ant_component_package" value="${str.com.filename}.zip" />
		<filter token="ant_template_id" value="${cfg.name}" />
		<filter token="ant_template_package" value="${str.tpl.filename}.zip" />
		<filter token="ant_plugin_content_id" value="${cfg.name}" />
		<filter token="ant_plugin_content_package" value="${str.plg.content.filename}.zip" />
		<filter token="ant_plugin_system_id" value="${cfg.name}" />
		<filter token="ant_plugin_system_package" value="${str.plg.sys.filename}.zip" />
		<filter token="ant_plugin_user_id" value="${cfg.name}" />
		<filter token="ant_plugin_user_package" value="${str.plg.user.filename}.zip" />
		<filter token="ant_module_bookmark_id" value="${cfg.pfx.mod}${cfg.name}_social_bookmark" />
		<filter token="ant_module_bookmark_package" value="${str.mod.bookmark.filename}.zip" />
	
		<condition property="do.zip">
			<istrue value="${cfg.zip}" />
		</condition>

		<!-- Init of changelog automatic build up -->
		<property name="git.title" value="JInbound Changelog" />
		<property name="git.log.dir" value="${cfg.buildpath}changelog" />
		<property name="git.log.filename" value="changelog.log" />
		<property name="git.log.file" value="${git.log.dir}/${git.log.filename}" />
		
		<property name="git.rootDir" value="/home/jeff/git/jinbound/0.x/src/" />
		<property name="git.buildDir" value="/home/jeff/git/jinbound/0.x/build/" />
		<property name="git.user" value="AnythingDig" />
		<property name="git.repo" value="jinbound" />

		<property name="ext.targetFile" value="${git.rootDir}/changelog.log" />
	</target>
	
	<target name="copyFiles">
		<!-- start filtering (ALL media will be in /media so we're ok to filter ALL the files!) -->
		<copy todir="${cfg.packages}/temp/staging/component" filtering="true">
			<fileset
				dir="${cfg.dir}/${cfg.pfx.com}${cfg.name}"
				includes="${cfg.name}.xml,${cfg.name}.install.php,admin/,language/,site/"
				excludes="admin/liveupdate/,**.git"
			/>
		</copy>
		<copy todir="${cfg.packages}/temp/staging/component/admin" filtering="false">
			<fileset
				dir="${cfg.dir}/${cfg.pfx.com}${cfg.name}/admin"
				includes="liveupdate/"
				excludes="**.git"
			/>
		</copy>
		<mkdir dir="${cfg.packages}/temp/staging/component/media" />
		<copy todir="${cfg.packages}/temp/staging/component/media" filtering="true">
			<fileset
				dir="${cfg.dir}/${cfg.pfx.com}${cfg.name}/media"
				includes="index.html,css/,js/"
				excludes="**.git"
			/>
		</copy>
		<copy todir="${cfg.packages}/temp/staging/component/media" filtering="false">
			<fileset
				dir="${cfg.dir}/${cfg.pfx.com}${cfg.name}/media"
				includes="images/,bootstrap/,ui/"
				excludes="**.git"
			/>
		</copy>
		<!-- now read xml file (the one in temp directory, after search/replace operation -->
		<xmlproperty file="${cfg.packages}/temp/staging/component/${cfg.name}.xml" collapseAttributes="true" prefix="xml" keepRoot="false" />

		<!-- template -->
		<copy todir="${cfg.packages}/temp/staging/template" filtering="true">
			<fileset
				dir="${cfg.dir}/${cfg.pfx.tpl}${cfg.name}"
				includes="templateDetails.xml,index.php,index.html,language/,css/"
				excludes="**.git"
			/>
		</copy>
		
		<!-- module -->
		<copy todir="${cfg.packages}/temp/staging/modules/${cfg.pfx.mod}${cfg.name}_social_bookmark" filtering="true">
			<fileset
				dir="${cfg.dir}/modules/${cfg.pfx.mod}${cfg.name}_social_bookmark"
				includes="${cfg.pfx.mod}${cfg.name}_social_bookmark.php,${cfg.pfx.mod}${cfg.name}_social_bookmark.xml,index.html,css/"
				excludes="**.git"
			/>
		</copy>
		<copy todir="${cfg.packages}/temp/staging/modules/${cfg.pfx.mod}${cfg.name}_social_bookmark" filtering="false">
			<fileset
				dir="${cfg.dir}/modules/${cfg.pfx.mod}${cfg.name}_social_bookmark"
				includes="icons/"
				excludes="**.git"
			/>
		</copy>

		<!-- akeeba subs plugin -->
		<copy todir="${cfg.packages}/temp/staging/plugins/akeebasubs" filtering="true">
			<fileset
				dir="${cfg.dir}/plugins/akeebasubs/${cfg.name}"
				includes="${cfg.name}.xml,${cfg.name}.php,index.html,language/"
				excludes="**.git"
			/>
		</copy>

		<!-- content plugin -->
		<copy todir="${cfg.packages}/temp/staging/plugins/content" filtering="true">
			<fileset
				dir="${cfg.dir}/plugins/content/${cfg.name}"
				includes="${cfg.name}.xml,${cfg.name}.php,index.html,language/"
				excludes="**.git"
			/>
		</copy>

		<!-- system plugin -->
		<copy todir="${cfg.packages}/temp/staging/plugins/system" filtering="true">
			<fileset
				dir="${cfg.dir}/plugins/system/${cfg.name}"
				includes="${cfg.name}.xml,${cfg.name}.php,index.html,language/"
				excludes="**.git"
			/>
		</copy>

		<!-- user plugin -->
		<copy todir="${cfg.packages}/temp/staging/plugins/user" filtering="true">
			<fileset
				dir="${cfg.dir}/plugins/user/${cfg.name}"
				includes="${cfg.name}.xml,${cfg.name}.php,index.html,forms/,language/"
				excludes="**.git"
			/>
		</copy>
		
		<!-- filter package manifest -->
		<copy todir="${cfg.packages}/temp/staging" filtering="true">
			<fileset dir="${cfg.dir}" includes="${cfg.pfx.pkg}${cfg.name}.xml,${cfg.name}.install.php,language/" />
		</copy>
	</target>

	<!-- prompt user if need to rebuild changelog - useful when not online, as would -->
	<!-- make whole build process fail otherwise -->
	<target name="promptUser">
		<input message="Build changelogs (needs be online) (y/n)?" validargs="y,n" addproperty="do.buildchangelog" />
		<condition property="do.changelog">
			<equals arg1="y" arg2="${do.buildchangelog}" />
		</condition>
	</target>


	<!-- Automatic changelog from svn commits comments -->
	<target name="doChangelog" if="do.changelog">
		<echo message="Building    | ${git.title}" />
		<echo message="--------------------------------------------" />
		
		<echo>Making changelog ...</echo>
		<mkdir dir="${cfg.buildpath}changelog" />
		<echo>Created destination dir</echo>
		
		<echo>Fetching issues ...</echo>
		<input message="GitHub password for user ${cfg.git.username}" addproperty="git.password">
		</input>

		<exec executable="${cfg.curl.bin}" outputproperty="gitlog.out" output="${git.log.file}">
			<arg line="-s 'https://api.github.com/repos/${git.user}/${git.repo}/issues?filter=all&amp;state=closed&amp;labels=CL' -u ${cfg.git.username}:${git.password}" />
		</exec>
		<echo>Raw data fetched from repository</echo>
		
		<!-- use php logformat script to format log file-->
		<echo>Spawning logformat script using ${cfg.php.bin}</echo>
		<exec executable="${cfg.php.bin}">
			<arg line=' changelog/logformat.php --title="${git.title}" --build=${build.number}' />
		</exec>
		<echo>Raw git log processed</echo>
		
		<!-- Copy changelog to extension dir -->
		<copy file="${git.log.file}" tofile="${ext.targetFile}" />
		<echo message="Done ---------------------------------------" />
	</target>
	
	<target name="cleanprev">
		<!-- move current build to ../previous directory -->
		<move todir="${cfg.packages}/previous">
			<fileset dir="${cfg.packages}/current" includes="*.zip" />
		</move>
	</target>
	
	<target name="zipFiles" depends="mkdir">
		<echo message="Building    | ${str.pkg.file}.zip" />
		<echo message="xml file    | ${cfg.dir}/${cfg.pfx.com}${cfg.name}/${cfg.name}.xml" />
		<echo message="xml version | ${str.version}" />
		<echo message="target      | Joomla" />
		<echo message="--------------------------------------------" />
		<echo message="    o base dir  - ${cfg.dir}" />
		<echo message="    o unver dir - ${cfg.unver}" />
		<echo message="--------------------------------------------" />
		
		<!-- create zip and include all files needed -->

		<!-- files with updated build and date number -->
		<zip destfile="${str.com.file}.zip" update="false">
			<zipfileset dir="${cfg.packages}/temp/staging/component" excludes="" />
		</zip>
		<zip destfile="${str.tpl.file}.zip" update="false">
			<zipfileset dir="${cfg.packages}/temp/staging/template" excludes="" />
		</zip>
		<zip destfile="${str.plg.akeebasubs.file}.zip" update="false">
			<zipfileset dir="${cfg.packages}/temp/staging/plugins/akeebasubs" excludes="" />
		</zip>
		<zip destfile="${str.plg.content.file}.zip" update="false">
			<zipfileset dir="${cfg.packages}/temp/staging/plugins/content" excludes="" />
		</zip>
		<zip destfile="${str.plg.sys.file}.zip" update="false">
			<zipfileset dir="${cfg.packages}/temp/staging/plugins/system" excludes="" />
		</zip>
		<zip destfile="${str.plg.user.file}.zip" update="false">
			<zipfileset dir="${cfg.packages}/temp/staging/plugins/user" excludes="" />
		</zip>
		<zip destfile="${str.mod.bookmark.file}.zip" update="false">
			<zipfileset dir="${cfg.packages}/temp/staging/modules/mod_jinbound_social_bookmark" excludes="" />
		</zip>
		
		<!-- create pkg -->
		<zip destfile="${str.pkg.file}.zip" update="false">
			<zipfileset dir="${cfg.packages}/temp" includes="packages/" />
		</zip>
		<zip destfile="${str.pkg.file}.zip" update="true">
			<zipfileset dir="${cfg.packages}/temp/staging" includes="${cfg.pfx.pkg}${cfg.name}.xml,${cfg.name}.install.php,language/" />
		</zip>
		<zip destfile="${str.pkg.file}.zip" update="true">
			<zipfileset dir="${git.rootDir}" includes="changelog.log" />
		</zip>
	</target>
	
	<!-- create target directory if does not exist -->
	<target name="mkdir">
		<mkdir dir="${cfg.packages}" />
	</target>

	<!-- delete temp dirs -->
	<target name="deldir">
		<delete dir="${cfg.packages}/temp" />
	</target>

	<!-- display information -->
	<target name="info" depends="init">
		<echo message="Ant Version: ${ant.version}" />
		<echo message="Project:     ${cfg.name}" />
		<echo message="Version:     ${xml.version}" />
		<echo message="Build:       ${build.number}" />
		<echo message="Date:        ${TODAY}" />
	</target>
</project>